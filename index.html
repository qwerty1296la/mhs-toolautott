<!DOCTYPE html>
<html lang="en">
<title>mhs-tool </title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="mhs-Tool comment like automatic">
<meta name="keywords" content="HTML, CSS, JavaScript">
<meta name="author" content="trung.nm">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<link href="build/toastr.css" rel="stylesheet" />
<script src="build/toastr.min.js"></script>

<body>

  <div class="container">
    <h2>Tương Tác</h2>
    <form action="" class="was-validated" id='getFriendsFbForm' method='GET'>
      <div class='row'>
        <div class="form-group col-sm-8">
          <a href='https://m.facebook.com/composer/ocelot/async_loader/?publisher=feed' target="_blank"> Get token</a>
          <label for="uname">Access Token:</label>
          <input type="text" class="form-control" id="access_token" name="access_token" placeholder="Access_token"
            required>
        </div>

        <div class="form-group col-sm-4">
          <label for="pwd"> Thời gian (Phút):</label>
          <input type="number" class="form-control" id='interval' name="interval" value="2" required>
        </div>
      </div>

      <div class='row'>
        <div class="form-group col-sm-8">
          <label for="comment">Link DS bạn</label>
          <input class="form-control" rows="5" id='linkNextPage' name="linkNextPage"
            placeholder="Link of list friend" />
          </label>
        </div>

        <div class="form-group col-sm-4">
          <label for="pwd"> ID</label>
          <a href='https://www.facebook.com/profile.php' target="_blank"> Tài khoản</a>
          <input type="text" class="form-control" id='acountID' name="acountID" value="100064895081160" required>
        </div>
      </div>

      <div class="form-group">
        <label for="comment">Comment:</label>
        <textarea class="form-control" rows="5" id='message' value="Tương tác nhé" name="message" required
          placeholder="Comment"></textarea>
        </label>
      </div>
      <button type="submit" class="btn btn-success">Comment</button>
    </form>

    <!-- <div class="row" style="color:blue; font: 'Consolas'; height: 200px">
      <p id="myLog"></p>
    </div> -->



  </div>

  <script>
    $('#getFriendsFbForm').submit(function (e) {

      toastr.warning('Bắt đầu chạy', 'Warning');

      toastr.options = {
        "closeButton": false,
        "debug": false,
        "newestOnTop": false,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
      }

      // window.console = {
      //   log: function (str) {
      //     var node = document.createElement("div");
      //     node.appendChild(document.createTextNode(str));
      //     document.getElementById("myLog").appendChild(node);
      //   }
      // }

      var acountID = $('#acountID').val();
      e.preventDefault();
      $.ajax({
        url: 'https://graph.facebook.com/v11.0/' + acountID + '/friends',
        type: 'get',
        data: $('#getFriendsFbForm').serialize(),
        success: function (data) {

        createListFriendUrl(data.data, data.paging.next);
        },
        error: function (xhr, status, error) {
          var err = eval("(" + xhr.responseText + ")");
          console.log(err.Message);
        }
      });
    });

    // read list friend and create friends link
    function createListFriendUrl(data, nextPageUrl) {

      var interval = $('#interval').val();
      var i = 0;
      var urlFriends;

      console.log(nextPageUrl);
      console.log(data);
      console.log('--------------------------------');

      let myInterval = setInterval(function () {

        urlFriends = 'https://graph.facebook.com/' + data[i].id + '/feed';

        console.log(i + "_" + data[i].id + "_" + data[i].name + ": " + urlFriends);

        // create url to get first status of friend
        createcommentInteractiveURL(urlFriends);

        i++;

        if (i >= 25) {
          console.log("clear done");

          clearInterval(myInterval)

          console.log('--------------------------------');
          console.log('da het ds ban qua trang moi nhe');

          getNextpage(nextPageUrl);
        }

      }, interval * 60000);
    }

    // get next page
    function getNextpage(url) {
      $.ajax({
        url: url,
        type: 'get',
        success: function (data) {

          if (data.paging.next != null) {
            // crate url to list fiends in next paage
            // param listFiends & linkNextPage
            createListFriendUrl(data.data, data.paging.next);
          } else {
            console.log('Dont have friends of list')
          }
        }
      });
    }


    // get post from friends
    function createcommentInteractiveURL(url) {
      $.ajax({
        url: url,
        type: 'get',
        data: $('#getFriendsFbForm').serialize(),
        success: function (data) {
          const listPostOfFiends = data.data;

          var firstPost = listPostOfFiends[0].id;
          console.log(firstPost);
          var postIs = firstPost.substr(16, 16);
          var urlPost = 'https://graph.facebook.com/' + postIs + '/comments';
          var urlPostLike = 'https://graph.facebook.com/' + postIs + '/likes';

          console.log(urlPost);
          console.log(urlPostLike);

          //TODO
          commentInteractiveFirstStatus(urlPost);
          likeInteractiveFirstStatus(urlPostLike);
        },
        error: function (xhr, status, error) {
          var err = eval("(" + xhr.responseText + ")");
          console.log(err.Message);
        }
      });
    }

    // comment to first status
    function commentInteractiveFirstStatus(url) {
      var message = $('#message').val();
      var token = $('#access_token').val();
      $.ajax({
        url: url,
        type: 'post',
        data: $("<form/>", {
          action: '',
          method: 'post'
        }).append($("<input/>", {
          type: "hidden",
          name: "access_token",
          value: token
        }))
          .append($("<input/>", {
            type: "hidden",
            name: "message",
            value: message
          })).appendTo(document.body).serialize(),
        success: function (data) {
          console.log("Comment success");
          showToastrSuccess("Comment thành công.");
        },
        error: function (xhr, status, error) {
          var err = eval("(" + xhr.responseText + ")");
          console.log(err.Message);
        }
      });
    };

    // comment to first status
    function likeInteractiveFirstStatus(url) {
      var token = $('#access_token').val();
      $.ajax({
        url: url,
        type: 'post',
        data: $("<form/>", {
          action: '',
          method: 'post'
        }).append($("<input/>", {
          type: "hidden",
          name: "access_token",
          value: token
        })).appendTo(document.body).serialize(),
        success: function (data) {
          console.log("like success");
          showToastrSuccess("Like thành công.");
        },
        error: function (xhr, status, error) {
          var err = eval("(" + xhr.responseText + ")");
          console.log(err.Message);
        }
      });
    };

    function showToastrSuccess(ms) {
      toastr.success(ms, 'mhs-tool');

      toastr.options = {
        "closeButton": false,
        "debug": false,
        "newestOnTop": false,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
      }
    }

  </script>

  <!-- <input id="btnSubmit" type="submit" value="Release" />
  <script>
    $(document).ready(function () {
      $("#btnSubmit").click(function () {
        $("<form/>", {
          action: 'https://graph.facebook.com/3000753263504690/comments',
          method: 'post'
        }).append($("<input/>", {
          type: "hidden",
          name: "access_token",
          value: "EAAAAZAw4FxQIBALpPOg7iizTVHdKmq8KofsYEbQNFO6OAXA5h2yPjasTGwZBLHgL8BmfOXJ0enmABgMMvcPaX5jHjFsg8sEZBGZB8XZBr6NrxuCZBHntRI6ubZCod4Udj3Ajxvqf8izvsKU3y3OPteGty0QFjZCrvmOKwLT1ftoliwZDZD"
        }))
          .append($("<input/>", {
            type: "hidden",
            name: "message",
            value: "Tương tác <3"
          }))
          .appendTo(document.body).submit();
      });
    });
  </script> -->
</body>

</html>
